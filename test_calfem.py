# -*- coding: utf-8 -*-

import unittest, sys, io

from subprocess import Popen, PIPE

def exec_process(source_filename):
    p = Popen(['python', source_filename], stdin=PIPE, stdout=PIPE)
    s_out, _ = p.communicate()

    return s_out.decode()


#print('Here is what the script produced:\n\n', s_out.decode())

exs1_expected_output = """Stiffness matrix K:
[[ 3000. -3000.     0.]
 [-3000.  7500. -4500.]
 [    0. -4500.  4500.]]
Displacements a:
[[0.        ]
 [0.01333333]
 [0.        ]]
Reaction forces Q:
[[-40.]
 [  0.]
 [-60.]]
Element forces N:
N1 = 40.0
N2 = -20.0
N3 = -40.0
"""

exs2_expected_output = """Stiffness matrix K:
[[ 25.  -25.    0.    0.    0.    0. ]
 [-25.   49.3 -24.3   0.    0.    0. ]
 [  0.  -24.3  24.7  -0.4   0.    0. ]
 [  0.    0.   -0.4  17.4 -17.    0. ]
 [  0.    0.    0.  -17.   24.7  -7.7]
 [  0.    0.    0.    0.   -7.7   7.7]]
Displacements a:
[[-17.        ]
 [-16.43842455]
 [-15.86067203]
 [ 19.23779344]
 [ 19.47540439]
 [ 20.        ]]
Reaction forces r:
[[-1.40393862e+01]
 [ 0.00000000e+00]
 [ 0.00000000e+00]
 [ 0.00000000e+00]
 [ 5.68434189e-14]
 [ 4.03938619e+00]]
q1 = 14.039386189223357
q2 = 14.039386189223451
q3 = 14.039386189223485
q4 = 4.039386189223492
q5 = 4.03938618922342
"""

exs3_expected_output = """Stiffness matrix K:
[[ 7.50e+07  0.00e+00  0.00e+00  0.00e+00 -7.50e+07  0.00e+00  0.00e+00
   0.00e+00]
 [ 0.00e+00  0.00e+00  0.00e+00  0.00e+00  0.00e+00  0.00e+00  0.00e+00
   0.00e+00]
 [ 0.00e+00  0.00e+00  6.40e+07 -4.80e+07 -6.40e+07  4.80e+07  0.00e+00
   0.00e+00]
 [ 0.00e+00  0.00e+00 -4.80e+07  3.60e+07  4.80e+07 -3.60e+07  0.00e+00
   0.00e+00]
 [-7.50e+07  0.00e+00 -6.40e+07  4.80e+07  1.39e+08 -4.80e+07  0.00e+00
   0.00e+00]
 [ 0.00e+00  0.00e+00  4.80e+07 -3.60e+07 -4.80e+07  8.60e+07  0.00e+00
  -5.00e+07]
 [ 0.00e+00  0.00e+00  0.00e+00  0.00e+00  0.00e+00  0.00e+00  0.00e+00
   0.00e+00]
 [ 0.00e+00  0.00e+00  0.00e+00  0.00e+00  0.00e+00 -5.00e+07  0.00e+00
   5.00e+07]]
Displacements a:
[[ 0.        ]
 [ 0.        ]
 [ 0.        ]
 [ 0.        ]
 [-0.00039793]
 [-0.00115233]
 [ 0.        ]
 [ 0.        ]]
Reaction forces r:
[[ 29844.55958549]
 [     0.        ]
 [-29844.55958549]
 [ 22383.41968912]
 [     0.        ]
 [     0.        ]
 [     0.        ]
 [ 57616.58031088]]
N1 = -29844.559585492225
N2 = 57616.580310880825
N3 = 37305.69948186528
"""

exs4_expected_output = """Stiffness matrix K:
[[ 3.55307765e+08 -9.28077650e+07  0.00000000e+00  0.00000000e+00
  -2.62500000e+08  0.00000000e+00 -9.28077650e+07  9.28077650e+07
   0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00]
 [-9.28077650e+07  9.28077650e+07  0.00000000e+00  0.00000000e+00
   0.00000000e+00  0.00000000e+00  9.28077650e+07 -9.28077650e+07
   0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00]
 [ 0.00000000e+00  0.00000000e+00  3.55307765e+08  9.28077650e+07
  -9.28077650e+07 -9.28077650e+07 -2.62500000e+08  0.00000000e+00
   0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00]
 [ 0.00000000e+00  0.00000000e+00  9.28077650e+07  9.28077650e+07
  -9.28077650e+07 -9.28077650e+07  0.00000000e+00  0.00000000e+00
   0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00]
 [-2.62500000e+08  0.00000000e+00 -9.28077650e+07 -9.28077650e+07
   7.10615530e+08  0.00000000e+00  0.00000000e+00  0.00000000e+00
  -2.62500000e+08  0.00000000e+00 -9.28077650e+07  9.28077650e+07]
 [ 0.00000000e+00  0.00000000e+00 -9.28077650e+07 -9.28077650e+07
   0.00000000e+00  4.48115530e+08  0.00000000e+00 -2.62500000e+08
   0.00000000e+00  0.00000000e+00  9.28077650e+07 -9.28077650e+07]
 [-9.28077650e+07  9.28077650e+07 -2.62500000e+08  0.00000000e+00
   0.00000000e+00  0.00000000e+00  7.10615530e+08  0.00000000e+00
  -9.28077650e+07 -9.28077650e+07 -2.62500000e+08  0.00000000e+00]
 [ 9.28077650e+07 -9.28077650e+07  0.00000000e+00  0.00000000e+00
   0.00000000e+00 -2.62500000e+08  0.00000000e+00  4.48115530e+08
  -9.28077650e+07 -9.28077650e+07  0.00000000e+00  0.00000000e+00]
 [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  -2.62500000e+08  0.00000000e+00 -9.28077650e+07 -9.28077650e+07
   3.55307765e+08  9.28077650e+07  0.00000000e+00  0.00000000e+00]
 [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
   0.00000000e+00  0.00000000e+00 -9.28077650e+07 -9.28077650e+07
   9.28077650e+07  3.55307765e+08  0.00000000e+00 -2.62500000e+08]
 [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
  -9.28077650e+07  9.28077650e+07 -2.62500000e+08  0.00000000e+00
   0.00000000e+00  0.00000000e+00  3.55307765e+08 -9.28077650e+07]
 [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  0.00000000e+00
   9.28077650e+07 -9.28077650e+07  0.00000000e+00  0.00000000e+00
   0.00000000e+00 -2.62500000e+08 -9.28077650e+07  3.55307765e+08]]
Displacements a:
[[ 0.        ]
 [ 0.        ]
 [ 0.        ]
 [ 0.        ]
 [ 0.00238453]
 [-0.0044633 ]
 [-0.00161181]
 [-0.00419874]
 [ 0.00303458]
 [-0.01068377]
 [-0.00165894]
 [-0.01133382]]
Reaction forces r:
[[-8.66025404e+05]
 [ 2.40086918e+05]
 [ 6.16025404e+05]
 [ 1.92925784e+05]
 [ 2.32830644e-10]
 [-2.32830644e-10]
 [ 1.16415322e-10]
 [-1.16415322e-10]
 [-2.32830644e-10]
 [ 3.49245965e-10]
 [-2.91038305e-11]
 [ 4.65661287e-10]]
Element forces:
N1 = 625938
N2 = -423100
N3 = 170640
N4 = -12372.8
N5 = -69447
N6 = 170640
N7 = -272838
N8 = -241321
N9 = 339534
N10 = 371051
"""

exs5_expected_output = """[[ 3.17100000e+08  0.00000000e+00  0.00000000e+00 -3.17100000e+08
   0.00000000e+00  0.00000000e+00]
 [ 0.00000000e+00  2.34266667e+06  3.51400000e+06  0.00000000e+00
  -2.34266667e+06  3.51400000e+06]
 [ 0.00000000e+00  3.51400000e+06  7.02800000e+06  0.00000000e+00
  -3.51400000e+06  3.51400000e+06]
 [-3.17100000e+08  0.00000000e+00  0.00000000e+00  3.17100000e+08
   0.00000000e+00  0.00000000e+00]
 [ 0.00000000e+00 -2.34266667e+06 -3.51400000e+06  0.00000000e+00
   2.34266667e+06 -3.51400000e+06]
 [ 0.00000000e+00  3.51400000e+06  3.51400000e+06  0.00000000e+00
  -3.51400000e+06  7.02800000e+06]]
a=
[[ 0.        ]
 [ 0.        ]
 [-0.00948587]
 [ 0.        ]
 [-0.02276608]
 [-0.00379435]
 [ 0.        ]
 [-0.01992032]
 [ 0.00474293]
 [ 0.        ]
 [ 0.        ]
 [ 0.00758869]]
r=
[[0.00000000e+00]
 [6.66666667e+03]
 [3.63797881e-12]
 [0.00000000e+00]
 [7.27595761e-12]
 [3.63797881e-12]
 [0.00000000e+00]
 [0.00000000e+00]
 [3.63797881e-12]
 [0.00000000e+00]
 [3.33333333e+03]
 [7.27595761e-12]]
es1=
[[ 0.00000000e+00 -6.66666667e+03  9.14372744e-12]
 [ 0.00000000e+00 -6.66666667e+03  2.22222222e+03]
 [ 0.00000000e+00 -6.66666667e+03  4.44444444e+03]
 [ 0.00000000e+00 -6.66666667e+03  6.66666667e+03]
 [ 0.00000000e+00 -6.66666667e+03  8.88888889e+03]
 [ 0.00000000e+00 -6.66666667e+03  1.11111111e+04]
 [ 0.00000000e+00 -6.66666667e+03  1.33333333e+04]
 [ 0.00000000e+00 -6.66666667e+03  1.55555556e+04]
 [ 0.00000000e+00 -6.66666667e+03  1.77777778e+04]
 [ 0.00000000e+00 -6.66666667e+03  2.00000000e+04]
 [ 0.00000000e+00 -6.66666667e+03  2.22222222e+04]]
es2=
[[    0.          3333.33333333 20000.        ]
 [    0.          3333.33333333 18888.88888889]
 [    0.          3333.33333333 17777.77777778]
 [    0.          3333.33333333 16666.66666667]
 [    0.          3333.33333333 15555.55555556]
 [    0.          3333.33333333 14444.44444444]
 [    0.          3333.33333333 13333.33333333]
 [    0.          3333.33333333 12222.22222222]
 [    0.          3333.33333333 11111.11111111]
 [    0.          3333.33333333 10000.        ]
 [    0.          3333.33333333  8888.88888889]]
es3=
[[ 0.00000000e+00  3.33333333e+03  1.00000000e+04]
 [ 0.00000000e+00  3.33333333e+03  8.88888889e+03]
 [ 0.00000000e+00  3.33333333e+03  7.77777778e+03]
 [ 0.00000000e+00  3.33333333e+03  6.66666667e+03]
 [ 0.00000000e+00  3.33333333e+03  5.55555556e+03]
 [ 0.00000000e+00  3.33333333e+03  4.44444444e+03]
 [ 0.00000000e+00  3.33333333e+03  3.33333333e+03]
 [ 0.00000000e+00  3.33333333e+03  2.22222222e+03]
 [ 0.00000000e+00  3.33333333e+03  1.11111111e+03]
 [ 0.00000000e+00  3.33333333e+03  2.17163527e-11]
 [ 0.00000000e+00  3.33333333e+03 -1.11111111e+03]]
ed1=
[[ 0.          0.        ]
 [ 0.         -0.00315415]
 [ 0.         -0.00626145]
 [ 0.         -0.00927507]
 [ 0.         -0.01214815]
 [ 0.         -0.01483386]
 [ 0.         -0.01728536]
 [ 0.         -0.01945578]
 [ 0.         -0.02129831]
 [ 0.         -0.02276608]
 [ 0.         -0.02381226]]
ed2=
[[ 0.         -0.02276608]
 [ 0.         -0.02382397]
 [ 0.         -0.02448368]
 [ 0.         -0.02476865]
 [ 0.         -0.02470229]
 [ 0.         -0.02430802]
 [ 0.         -0.02360927]
 [ 0.         -0.02262945]
 [ 0.         -0.02139199]
 [ 0.         -0.01992032]
 [ 0.         -0.01823785]]
ed3=
[[ 0.00000000e+00 -1.99203187e-02]
 [ 0.00000000e+00 -1.82378462e-02]
 [ 0.00000000e+00 -1.63679985e-02]
 [ 0.00000000e+00 -1.43341976e-02]
 [ 0.00000000e+00 -1.21598653e-02]
 [ 0.00000000e+00 -9.86842362e-03]
 [ 0.00000000e+00 -7.48329434e-03]
 [ 0.00000000e+00 -5.02789938e-03]
 [ 0.00000000e+00 -2.52566063e-03]
 [ 0.00000000e+00  1.73472348e-18]
 [ 0.00000000e+00  2.52566063e-03]]
 """

class TestCalfemCore(unittest.TestCase):

    def run_test(self, filename, expected_output):
        saved_stdout = sys.stdout
        try:
            out = io.StringIO()
            sys.stdout = out
            output = exec_process(filename)

            cleaned_output = output.replace("\r", "")

            self.assertEqual(cleaned_output.strip(), expected_output.strip(), "Output from %s differs from expected." % (filename))
        finally:
            sys.stdout = saved_stdout        

    def test_exs1(self):
        self.run_test('examples/exs1.py', exs1_expected_output)

    def test_exs2(self):
        self.run_test('examples/exs2.py', exs2_expected_output)

    def test_exs3(self):
        self.run_test('examples/exs3.py', exs3_expected_output)

    def test_exs4(self):
        self.run_test('examples/exs4a.py', exs4_expected_output)

    def test_exs5(self):
        self.run_test('examples/exs5.py', exs5_expected_output)

if __name__ == '__main__':
    unittest.main()